<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Experiencia Navideña - Rodrigo</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&family=Great+Vibes&family=Montserrat:wght@400;700&family=Playfair+Display:ital,wght@1,400&display=swap" rel="stylesheet">

    <style>
        /* VARIABLES DE COLOR Y ESTILO */
        :root {
            --gold-dark: #dba51b;
            --gold-light: #ebc909e1;
            --neon-red: #ec2525;
            --deep-red: #800000;
            --bg-elegant: radial-gradient(circle at center, #2c1e1e 0%, #0a0505 100%);
        }

        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; font-family: 'Montserrat', sans-serif; }

        /* NUEVOS ESTILOS PARA TEXTOS DE GUÍA */
        .guia-texto {
            position: absolute;
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.6);
            background: rgba(255, 255, 255, 0.05);
            padding: 4px 8px;
            border-radius: 4px;
            pointer-events: none; /* No bloquea el clic */
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: opacity 0.5s;
            z-index: 2000;
        }

        /* ANIMACIÓN DE FLOTADO */
        @keyframes animeFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }

        /* --- FASE 1: PANTALLA DE INICIO --- */
        #intro-screen {
            position: fixed; inset: 0; display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 2000;
            background: var(--bg-elegant);
        }

        .elegant-title {
            font-family: 'Cinzel Decorative', serif; font-size: clamp(4rem, 10vw, 7rem);
            color: #fff; text-align: center; margin-bottom: 50px;
            text-shadow: 0 0 10px var(--neon-red), 0 0 20px var(--neon-red), 4px 4px 0px #4a0000; 
            animation: animeFloat 4s ease-in-out infinite;
        }

        .neon-button-container {
            padding: 4px; background: linear-gradient(90deg, var(--neon-red), #ff0000, var(--neon-red));
            border-radius: 8px; box-shadow: 0 0 20px var(--neon-red);
            animation: animeFloat 4s ease-in-out infinite 0.5s;
        }

        .neon-button {
            background: #1a0000; color: var(--neon-red); border: none;
            padding: 15px 40px; font-family: 'Montserrat', sans-serif; font-weight: 700;
            font-size: 1.2rem; text-transform: uppercase; cursor: pointer;
            letter-spacing: 2px; display: block; border-radius: 6px;
            text-shadow: 0 0 8px var(--neon-red); transition: 0.3s;
        }
        .neon-button:hover { background: var(--neon-red); color: white; text-shadow: none; }

        /* --- FASE 2: LA CARTA --- */
        #letter-stage {
            position: fixed; inset: 0; z-index: 1500; pointer-events: none;
            display: flex; justify-content: center; align-items: flex-end;
            perspective: 1000px;
        }

        #letter-container {
            width: 360px; height: 250px; position: relative; bottom: -300px;
            pointer-events: auto; transform-style: preserve-3d;
        }

        .envelope {
            width: 100%; height: 100%; background: var(--deep-red);
            border-radius: 5px; position: relative; z-index: 2;
            box-shadow: 0 25px 50px rgba(0,0,0,0.9), inset 0 0 30px rgba(0,0,0,0.5);
            border: 2px solid #ca0606c9;
            background-image: url('https://www.transparenttextures.com/patterns/aged-paper.png');
        }

        .ribbon {
            position: absolute; top: 0; left: 60px; width: 40px; height: 100%;
            background: linear-gradient(to right, var(--gold-dark), var(--gold-light), var(--gold-dark));
            box-shadow: 0 2px 10px rgba(0,0,0,0.5); z-index: 3;
        }

        .virreinal-seal {
            position: absolute; bottom: 15px; left: 15px; width: 75px; height: 75px;
            background: radial-gradient(circle at 30% 30%, var(--gold-light), var(--gold-dark));
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            box-shadow: 4px 4px 15px rgba(0,0,0,0.6), inset 2px 2px 5px rgba(255,255,255,0.4);
            border: 4px groove var(--gold-dark); cursor: pointer; z-index: 10;
        }
        .virreinal-seal::after {
            content: 'R'; font-family: 'Cinzel Decorative', serif; font-size: 40px;
            color: #3a2300; text-shadow: 1px 1px 1px rgba(255,255,255,0.3); font-weight: bold;
        }

        .papyrus {
            position: absolute; top: 10px; left: 10px; right: 10px; height: 0;
            background: #f8f0c0; overflow: hidden; transition: 1s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1; box-shadow: 0 -5px 20px rgba(0,0,0,0.2);
            background-image: url('https://www.transparenttextures.com/patterns/old-map.png');
        }
        .papyrus.open { height: 480px; top: -400px; }

        .papyrus-content {
            height: 100%; box-sizing: border-box; padding: 30px;
            border: 5px double var(--deep-red); outline: 2px solid var(--gold-dark);
            outline-offset: -10px; text-align: center; color: #910000;
        }
        .papyrus-content h2 { font-family: 'Great Vibes', cursive; font-size: 3rem; margin: 0 0 20px 0; }
        .papyrus-content p { font-family: 'Playfair Display', serif; font-size: 1.1rem; line-height: 1.6; }

        /* --- UI --- */
        .music-ui {
            position: fixed; top: 20px; left: 20px; z-index: 3000; display: flex; gap: 10px;
            background: rgba(0,0,0,0.5); padding: 8px; border-radius: 30px; border: 1px solid var(--gold-dark);
        }
        .ui-btn { background: var(--gold-dark); color: #fff; border: none; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; }

        .top-right-seal {
            position: fixed; top: 20px; right: 20px; z-index: 3000;
            width: 60px; height: 60px; background: radial-gradient(circle, var(--gold-light), var(--gold-dark));
            border-radius: 50%; border: 3px solid #fff; cursor: pointer;
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 0 20px var(--gold-light); transition: 0.3s; font-family: 'Cinzel Decorative'; font-size: 30px; color: #3a2300;
        }
        .top-right-seal:hover { transform: rotate(15deg) scale(1.1); }

        #bottom-text {
            position: fixed; bottom: 30px; width: 100%; text-align: center;
            font-family: 'Cinzel Decorative', serif; font-size: 2.5rem; color: var(--gold-light);
            z-index: 100; pointer-events: none; opacity: 0; text-shadow: 0 0 10px var(--gold-dark);
            animation: animeFloat 5s ease-in-out infinite;
        }

        /* --- PANTALLA FINAL --- */
        #final-screen {
            position: fixed; inset: 0; 
            background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%);
            z-index: 4000; display: none; flex-direction: column; 
            justify-content: center; align-items: center; overflow: hidden;
            text-align: center; padding: 20px; box-sizing: border-box;
        }

        #final-screen::before {
            content: ""; position: absolute; width: 200%; height: 200%;
            background: url('https://www.transparenttextures.com/patterns/asfalt-dark.png'), 
                        radial-gradient(circle, rgba(255,255,255,0.05) 0%, transparent 70%);
            animation: smokeMove 20s linear infinite; opacity: 0.4;
        }

        @keyframes smokeMove {
            from { transform: translate(-10%, -10%) rotate(0deg); }
            to { transform: translate(10%, 10%) rotate(5deg); }
        }

        .final-msg {
            font-family: 'Cinzel Decorative', serif;
            font-size: clamp(2.5rem, 8vw, 6rem);
            font-weight: 900;
            background: linear-gradient(to bottom, #ffffff 0%, #a2a2a2 45%, #ffffff 50%, #757575 55%, #999999 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 0 15px rgba(255,255,255,0.5)) drop-shadow(5px 5px 0px rgba(0,0,0,0.8));
            letter-spacing: 2px; margin: 0; z-index: 10;
            animation: animeFloat 4s ease-in-out infinite;
            display: block; width: 100%;
        }

        .final-sign {
            font-family: 'Playfair Display', serif;
            font-style: italic; font-size: clamp(1.2rem, 5vw, 2.2rem);
            color: #e0e0e0; margin-top: 10px;
            text-shadow: 2px 2px 10px rgba(0,0,0,1);
            z-index: 10; border-top: 1px solid rgba(255,255,255,0.2);
            padding-top: 20px; width: 80%; max-width: 500px;
            animation: animeFloat 4s ease-in-out infinite 0.3s;
        }
    </style>
</head>
<body>

    <div id="intro-screen">
        <h1 class="elegant-title">Feliz Navidad</h1>
        <div class="neon-button-container">
            <button class="neon-button" onclick="startExperience()">Abre esta experiencia</button>
        </div>
    </div>

    <div id="guia-sello" class="guia-texto" style="bottom: 110px; left: 30px; display: none;">Toca el sello</div>
    <div id="guia-estrella" class="guia-texto" style="top: 80%; left: 30%; transform: translate(-50%, 80px); display: none; opacity: 0;">Toca la estrella una y otra vez</div>
    <div id="guia-final" class="guia-texto" style="top: 90px; right: 20px; display: none;">Finalizar</div>

    <!-- UI de música simplificada: solo botón play/pause -->
    <div class="music-ui">
        <button class="ui-btn" id="play-btn">▶</button>
    </div>

    <!-- Audio con tu música local (misma carpeta que el HTML) -->
    <audio id="bg-music" src="Snowfall.mp3" loop></audio>

    <div class="top-right-seal" onclick="showFinal()">R</div>

    <div id="letter-stage">
        <div id="letter-container">
            <div class="envelope">
                <div class="ribbon"></div>
                <div class="virreinal-seal" onclick="handleSealClick()"></div>
            </div>
            <div class="papyrus" id="papyrus">
                <div class="papyrus-content">
                    <h2>Feliz Navidad</h2>
                    <p>En este día tan especial, rodeado de la magia de las estrellas, te deseo paz, amor y momentos inolvidables junto a tus seres queridos.</p>
                    <p style="margin-top: 40px; font-weight: bold;">Atentamente,<br>Rodrigo</p>
                </div>
            </div>
        </div>
    </div>

    <div id="bottom-text">Feliz Navidad</div>

    <div id="final-screen">
        <h1 class="final-msg">FELIZ NAVIDAD</h1>
        <h2 class="final-sign">Atentamente, Rodrigo</h2>
    </div>

    <script>
        /* LÓGICA DE JAVASCRIPT Y 3D */
        let scene, camera, renderer, star, points, galaxy, shootingStars, controls;
        let isExploded = false;
        const particleCount = 65000; 
        const targetPos = new Float32Array(particleCount * 3);
        const currentPos = new Float32Array(particleCount * 3);
        const colors = new Float32Array(particleCount * 3);
        let letterState = 'closed';

        function init3D() {
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x000000, 0.02); 
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 2, 8);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setClearColor(0x000000);
            document.body.appendChild(renderer.domElement);

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true; controls.autoRotate = true; controls.autoRotateSpeed = 0.5;

            createGalaxy();      
            prepareTreeData();   
            createStar();        
            animate();           

            gsap.to(currentPos, {
                duration: 5,
                endArray: targetPos,
                ease: "expo.out",
                onUpdate: () => points.geometry.attributes.position.needsUpdate = true
            });
            gsap.to("#bottom-text", { opacity: 1, duration: 3, delay: 2 });

            // Mostrar guía de estrella y salir
            document.getElementById('guia-estrella').style.display = 'block';
            gsap.to("#guia-estrella", { opacity: 1, duration: 2 });
            document.getElementById('guia-final').style.display = 'block';
        }

        function prepareTreeData() {
            const geo = new THREE.BufferGeometry();
            for (let i = 0; i < particleCount; i++) {
                const t = Math.random();
                const angle = 25 * Math.PI * t; 
                const radius = 3 * (1 - t);     
                const spread = 0.4 * (1 -t);

                targetPos[i*3] = Math.cos(angle) * radius + (Math.random()-0.5)*spread;
                targetPos[i*3+1] = t * 7 - 3.5;
                targetPos[i*3+2] = Math.sin(angle) * radius + (Math.random()-0.5)*spread;

                currentPos[i*3] = 0; currentPos[i*3+1] = 0; currentPos[i*3+2] = 0;

                const r = Math.random();
                if(r>0.98) { colors[i*3]=1; colors[i*3+1]=0.2; colors[i*3+2]=0.2; }
                else if(r>0.96) { colors[i*3]=0.2; colors[i*3+1]=1; colors[i*3+2]=0.2; }
                else { colors[i*3]=1; colors[i*3+1]=0.8; colors[i*3+2]=0.1; }
            }
            geo.setAttribute('position', new THREE.BufferAttribute(currentPos, 3));
            geo.setAttribute('color', new THREE.BufferAttribute(colors, 3));
            const mat = new THREE.PointsMaterial({ size: 0.02, vertexColors: true, transparent: true, opacity: 0.9, blending: THREE.AdditiveBlending });
            points = new THREE.Points(geo, mat);
            scene.add(points);
        }

        function createStar() {
            const starGroup = new THREE.Group();
            const geo = new THREE.SphereGeometry(0.18, 24, 24);
            const mat = new THREE.MeshBasicMaterial({ color: 0xffffff });
            star = new THREE.Mesh(geo, mat);
            
            const glowGeo = new THREE.SphereGeometry(0.4, 24, 24);
            const glowMat = new THREE.MeshBasicMaterial({ color: 0xff0000, transparent: true, opacity: 0.3 });
            const aura = new THREE.Mesh(glowGeo, glowMat);
            
            const light = new THREE.PointLight(0xff0000, 8, 15);
            
            const sparksGeo = new THREE.BufferGeometry();
            const sparksCount = 200;
            const sparksPos = new Float32Array(sparksCount * 3);
            for(let i=0; i<sparksCount; i++) {
                sparksPos[i*3] = (Math.random()-0.5) * 0.8;
                sparksPos[i*3+1] = (Math.random()-0.5) * 0.8;
                sparksPos[i*3+2] = (Math.random()-0.5) * 0.8;
            }
            sparksGeo.setAttribute('position', new THREE.BufferAttribute(sparksPos, 3));
            const sparksMat = new THREE.PointsMaterial({ color: 0xff4444, size: 0.03, transparent: true });
            const sparks = new THREE.Points(sparksGeo, sparksMat);

            starGroup.add(star); starGroup.add(aura); starGroup.add(light); starGroup.add(sparks);
            starGroup.position.y = 3.7;
            scene.add(starGroup);

            gsap.to(aura.scale, { x: 1.5, y: 1.5, z: 1.5, duration: 1, repeat: -1, yoyo: true, ease: "sine.inOut" });
        }

        function createGalaxy() {
            const bgGeo = new THREE.BufferGeometry();
            const bgPos = [];
            for(let i=0; i<20000; i++) bgPos.push((Math.random()-0.5)*200, (Math.random()-0.5)*200, (Math.random()-0.5)*200);
            bgGeo.setAttribute('position', new THREE.Float32BufferAttribute(bgPos, 3));
            galaxy = new THREE.Points(bgGeo, new THREE.PointsMaterial({color: 0xffffff, size: 0.05}));
            scene.add(galaxy);

            const shootGeo = new THREE.BufferGeometry();
            const shootPos = new Float32Array(100 * 3 * 2);
            shootingStars = new THREE.LineSegments(shootGeo, new THREE.LineBasicMaterial({color: 0xffffff, transparent: true, opacity: 0.6}));
            scene.add(shootingStars);
        }

        function animate() {
            requestAnimationFrame(animate);
            if(points && !isExploded) {
                const pos = points.geometry.attributes.position.array;
                for(let i=0; i<particleCount; i++) {
                    if(Math.random() > 0.995) {
                        pos[i*3] = (Math.random()-0.5)*0.1; pos[i*3+1] = -3.5; pos[i*3+2] = (Math.random()-0.5)*0.1;
                    }
                    if(pos[i*3+1] < targetPos[i*3+1]) {
                         pos[i*3] += (targetPos[i*3] - pos[i*3]) * 0.02;
                         pos[i*3+1] += (targetPos[i*3+1] - pos[i*3+1]) * 0.02;
                         pos[i*3+2] += (targetPos[i*3+2] - pos[i*3+2]) * 0.02;
                    }
                }
                points.geometry.attributes.position.needsUpdate = true;
            }

            if(shootingStars) {
                const positions = shootingStars.geometry.attributes.position?.array || new Float32Array(100 * 3 * 2);
                for(let i=0; i<100; i++) {
                    if(Math.random()>0.98) {
                        const x = (Math.random()-0.5)*100; const y = Math.random()*50; const z = (Math.random()-0.5)*100;
                        positions[i*6] = x; positions[i*6+1] = y; positions[i*6+2] = z;
                        positions[i*6+3] = x - 2; positions[i*6+4] = y - 2; positions[i*6+5] = z - 2;
                    }
                     positions[i*6] -= 0.5; positions[i*6+1] -= 0.5; positions[i*6+2] -= 0.5;
                     positions[i*6+3] -= 0.5; positions[i*6+4] -= 0.5; positions[i*6+5] -= 0.5;
                }
                shootingStars.geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            }

            galaxy.rotation.y += 0.0002;
            controls.update();
            renderer.render(scene, camera);
        }

        const bgMusic = document.getElementById('bg-music');
        const playBtn = document.getElementById('play-btn');

        // Reproduce música cuando se inicia la experiencia (primer clic del usuario)
        function startExperience() {
            // Intentar reproducir la música en el clic del botón (apto para móviles)
            const playPromise = bgMusic.play();
            if (playPromise !== undefined) {
                playPromise.then(() => {
                    playBtn.innerText = "||";
                }).catch(() => {
                    // Si el navegador bloquea, el usuario puede usar el botón ▶
                    playBtn.innerText = "▶";
                });
            }

            gsap.to("#intro-screen", { opacity: 0, duration: 1, onComplete: () => {
                document.getElementById('intro-screen').style.display = 'none';
                gsap.to("#letter-container", { bottom: "50px", duration: 1.5, ease: "back.out(1)", onComplete: () => {
                    document.getElementById('guia-sello').style.display = 'block';
                }});
            }});
        }

        function handleSealClick() {
            const papyrus = document.getElementById('papyrus');
            const container = document.getElementById('letter-container');
            const guia = document.getElementById('guia-sello');

            if(letterState === 'closed') {
                papyrus.classList.add('open');
                guia.innerText = "Cierra la carta con el sello";
                letterState = 'open';
            } else if (letterState === 'open') {
                papyrus.classList.remove('open');
                guia.style.display = 'none';
                letterState = 'sealed';
                setTimeout(() => {
                    gsap.to(container, { 
                        scale: 0, opacity: 0, rotation: 720, duration: 1, ease: "power2.in",
                        onComplete: () => {
                            container.style.display = 'none';
                            init3D();
                        }
                    });
                }, 1000);
            }
        }

        /* --- CORRECCIÓN EXPLOSIÓN ANDROID --- */
        window.addEventListener('pointerdown', (e) => {
            if(!star || letterState !== 'sealed') return;
            const mouse = new THREE.Vector2((e.clientX/window.innerWidth)*2-1, -(e.clientY/window.innerHeight)*2+1);
            const ray = new THREE.Raycaster(); ray.setFromCamera(mouse, camera);
            if(ray.intersectObject(star).length > 0) {
                // Quitar guía de estrella al primer toque
                document.getElementById('guia-estrella').style.display = 'none';
                if(!isExploded) {
                    const burst = new Float32Array(particleCount * 3);
                    for(let i=0; i<particleCount*3; i++) burst[i] = (Math.random()-0.5)*30;
                    gsap.to(currentPos, { endArray: burst, duration: 1.2, ease: "expo.out", onUpdate: () => points.geometry.attributes.position.needsUpdate = true });
                    isExploded = true;
                } else {
                    gsap.to(currentPos, { endArray: targetPos, duration: 1.5, ease: "elastic.out(1, 0.5)", onUpdate: () => points.geometry.attributes.position.needsUpdate = true });
                    isExploded = false;
                }
            }
        });

        function showFinal() { 
            document.getElementById('guia-final').style.display = 'none';
            document.getElementById('final-screen').style.display = 'flex'; 
        }

        // Botón play/pause manual (por si el navegador bloquea el autoplay)
        playBtn.addEventListener('click', () => {
            if (bgMusic.paused) {
                bgMusic.play().then(() => {
                    playBtn.innerText = "||";
                }).catch(() => {
                    playBtn.innerText = "▶";
                });
            } else {
                bgMusic.pause();
                playBtn.innerText = "▶";
            }
        });

        window.addEventListener('resize', () => {
            if(camera) { camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth,window.innerHeight); }
        });
    </script>
</body>
</html>
